<!DOCTYPE html>
<html>
<head>
    <title>Virtual Dressing Room</title>
    <style>
        body { font-family: Arial; margin: 20px; }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1.2fr; /* col1: upload+wishlist, col2: result+tryon, col3: search+tops+bottom */
            grid-template-rows: auto auto auto auto; /* adjusts to content */
            gap: 16px;
            align-items: start;
        }

        /* generic boxes */
        .box {
            border: 1px solid #d0d0d0;
            padding: 8px;
            text-align: center;
            background: #fafafa;
            border-radius: 6px;
        }

        .box h3 {
            margin: 0 0 4px 0;
            font-size: 18px;
        }

        .box img {
            max-width: 100%;
            max-height: 360px;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            margin: 0 auto;
            background: #f5f5f5;
            border-radius: 4px;
        }

        /* position 1: upload */
        #upload-box {
            grid-column: 1;
            grid-row: 1 / span 2; /* tall left column */
        }

        /* position 2: result */
        #result-box {
            grid-column: 2;
            grid-row: 1 / span 2; /* tall middle column */
        }

        /* position 3: search bar (top-right small) */
        #search-bar-box {
            grid-column: 3;
            grid-row: 1;
        }

        /* position 4: tops list (right column middle) */
        #tops-box {
            grid-column: 3;
            grid-row: 2;
        }

        /* position 5: bottoms list (right column bottom) */
        #bottoms-box {
            grid-column: 3;
            grid-row: 3;
        }

        /* position 6: saved wishlist (full width row under 1+2) */
        #wishlist-section {
            grid-column: 1 / span 2;
            grid-row: 3;
        }

        /* position 7: saved try-on images (full width row under 1+2) */
        #tryon-gallery-section {
            grid-column: 1 / span 2;
            grid-row: 4;
        }

        /* search + products inner layout */
        #searchInput {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .products-list {
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            padding: 8px;
            background: #ffffff;
            max-height: 260px;
            overflow-y: auto;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .product-card {
            position: relative;
            background: #ffffff;
            border-radius: 6px;
            padding: 4px;
        }

        .product-card img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 4px;
            border: 2px solid transparent;
            background: #f8f8f8;
            cursor: pointer;
            display: block;
        }

        .product-card.top img.selected {
            border-color: #1976d2;
        }

        .product-card.bottom img.selected {
            border-color: #2e7d32;
        }

        .wish-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background: rgba(255,255,255,0.95);
            font-size: 16px;
            line-height: 26px;
            text-align: center;
            color: #888;
        }

        .wish-btn.active {
            color: #e53935;
        }

        .type-label {
            position: absolute;
            left: 6px;
            top: 6px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size: 11px;
            padding: 2px 5px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        #statusMessage {
            grid-column: 1 / span 3;
            margin-top: 4px;
            font-weight: bold;
            text-align: center;
            padding: 4px 0;
        }

        /* wishlist */
        #wishlist-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            border: 1px solid #d0d0d0;
            padding: 8px;
            background: #ffffff;
            min-height: 80px;
        }

        #wishlist-bar .wish-item {
            position: relative;
        }

        #wishlist-bar img {
            height: 80px;
            width: auto;
            object-fit: contain;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            background: #ffffff;
        }

        #wishlist-bar .remove-btn {
            position: absolute;
            top: 2px;
            right: 4px;
            cursor: pointer;
            background: white;
            border-radius: 50%;
            padding: 0 4px;
            font-size: 14px;
            line-height: 14px;
        }

        /* try-on gallery (7) */
        #tryon-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            border: 1px solid #d0d0d0;
            padding: 8px;
            background: #ffffff;
            min-height: 80px;
        }

        #tryon-gallery .tryon-item {
            position: relative;
        }

        #tryon-gallery img {
            height: 100px;
            width: auto;
            object-fit: contain;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: #fff;
        }

        #tryon-gallery .remove-tryon {
            position: absolute;
            top: 2px;
            right: 4px;
            cursor: pointer;
            background: white;
            border-radius: 50%;
            padding: 0 4px;
            font-size: 14px;
            line-height: 14px;
        }

        #downloadBtn, #saveTryOnBtn {
            padding: 6px 12px;
            margin: 0 4px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #444;
            background: #fff;
        }

        #resultActions {
            margin-top: 8px;
            display: none;   /* hidden until we have a result */
        }

        @media (max-width: 1000px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
            #upload-box,
            #result-box,
            #search-bar-box,
            #tops-box,
            #bottoms-box,
            #wishlist-section,
            #tryon-gallery-section {
                grid-column: 1;
                grid-row: auto;
            }
        }
    </style>
</head>
<body>
<h2>Virtual Dressing Room</h2>

<div class="main-layout">

  <!-- 1. Upload your image -->
  <div class="box" id="upload-box">
    <h3>Upload Your Image</h3>
    <input type="file" id="inputImage" accept="image/*"><br><br>
    <img id="userPreview">
  </div>

  <!-- 2. Result -->
  <div class="box" id="result-box">
    <h3>Result</h3>
    <img id="resultImage">
    <div id="resultActions">
      <button id="downloadBtn">Download Image</button>
      <button id="saveTryOnBtn">Save to Liked</button>
    </div>
  </div>

  <!-- 3. Search bar -->
  <div class="box" id="search-bar-box">
    <h3>Search Outfits</h3>
    <input
      type="text"
      id="searchInput"
      placeholder="Search (e.g. red top, blue bottom, jeans, pant)...">
  </div>

  <!-- 4. Tops -->
  <div class="box" id="tops-box">
    <h3>Tops</h3>
    <div class="products-list">
      <div id="tops-grid" class="products-grid"></div>
    </div>
  </div>

  <!-- 5. Bottom -->
  <div class="box" id="bottoms-box">
    <h3>Bottoms</h3>
    <div class="products-list">
      <div id="bottoms-grid" class="products-grid"></div>
    </div>
  </div>

  <!-- 6. Saved wishlist -->
  <div id="wishlist-section" class="box">
    <h3>Saved Wishlist</h3>
    <div id="wishlist-bar"></div>
  </div>

  <!-- 7. Saved try-on images -->
  <div id="tryon-gallery-section" class="box">
    <h3>Saved Try-On Images</h3>
    <div id="tryon-gallery"></div>
  </div>

  <div id="statusMessage"></div>
</div>

<script>
let currentGender = "men";
let currentFile = null;
let selectedTop = null;
let selectedBottom = null;

let allProducts = [];   // { url, type, title }
let wishlist = new Set();
let savedTryOns = [];   // base64 strings

const statusDiv = document.getElementById("statusMessage");
const topsGrid = document.getElementById("tops-grid");
const bottomsGrid = document.getElementById("bottoms-grid");
const wishlistBar = document.getElementById("wishlist-bar");
const searchInput = document.getElementById("searchInput");
const tryonGallery = document.getElementById("tryon-gallery");

// upload handler
document.getElementById("inputImage").onchange = async function (e) {
    const file = e.target.files[0];
    if (!file) return;

    currentFile = file;
    document.getElementById("userPreview").src =
        URL.createObjectURL(file);

    selectedTop = null;
    selectedBottom = null;
    topsGrid.innerHTML = "";
    bottomsGrid.innerHTML = "";
    document.getElementById("resultImage").src = "";
    document.getElementById("resultActions").style.display = "none";

    await classifyGenderAndLoadProducts(file);
};

async function classifyGenderAndLoadProducts(file) {
    const form = new FormData();
    form.append("file", file);

    statusDiv.style.color = "black";
    statusDiv.textContent = "Detecting gender...";

    const res = await fetch("/classify-gender", { method: "POST", body: form });
    const data = await res.json();

    if (!res.ok) {
        statusDiv.style.color = "red";
        if (data.error === "no_person") {
            statusDiv.textContent = "Invalid image: no person detected. Upload a full-body photo.";
        } else if (data.error === "gender_unknown") {
            statusDiv.textContent = "Could not detect gender. Try a clearer, front-facing image.";
        } else {
            statusDiv.textContent = "Classification failed.";
        }
        topsGrid.innerHTML = "";
        bottomsGrid.innerHTML = "";
        document.getElementById("resultImage").src = "";
        return;
    }

    currentGender = data.gender;
    statusDiv.style.color = "green";
    statusDiv.textContent =
        "Detected: " + currentGender +
        ". Click a TOP and a BOTTOM to try the full outfit.";

    await loadProducts(currentGender);
    renderProducts();
}

// load products from backend
async function loadProducts(gender) {
    const res = await fetch(`/clothes?gender=${encodeURIComponent(gender)}`);
    const data = await res.json();   // [{url, type}, ...]

    allProducts = data.map(item => {
        const url = item.url;
        const kind = (item.type || "").toLowerCase(); // "top" or "bottom"
        let name = url.split("/").pop().split(".")[0];
        name = name.replace(/[_\-]+/g, " ");
        const title = (kind + " " + name).toLowerCase();
        return { url, type: kind, title };
    });
}

// split into tops and bottoms grids
function renderProducts() {
    topsGrid.innerHTML = "";
    bottomsGrid.innerHTML = "";

    const q = searchInput.value.trim().toLowerCase();

    allProducts.forEach(item => {
        const text = (item.title + " " + item.url).toLowerCase();
        if (q && !text.includes(q)) return;

        const card = document.createElement("div");
        card.className = "product-card " + item.type;

        const typeLabel = document.createElement("div");
        typeLabel.className = "type-label";
        typeLabel.textContent = item.type;

        const img = document.createElement("img");
        img.src = item.url;
        img.alt = item.title;
        img.title = item.title;

        img.onclick = async () => {
            document.querySelectorAll(".product-card." + item.type + " img")
                .forEach(i => i.classList.remove("selected"));
            img.classList.add("selected");

            if (item.type === "top") {
                selectedTop = item.url;
            } else {
                selectedBottom = item.url;
            }
            await autoTryOn();
        };

        const heart = document.createElement("button");
        heart.className = "wish-btn";
        heart.innerHTML = "&#10084;";

        if (wishlist.has(item.url)) {
            heart.classList.add("active");
        }

        heart.onclick = (event) => {
            event.stopPropagation();
            toggleWishlist(item.url);
            if (wishlist.has(item.url)) {
                heart.classList.add("active");
            } else {
                heart.classList.remove("active");
            }
        };

        card.appendChild(img);
        card.appendChild(typeLabel);
        card.appendChild(heart);

        if (item.type === "top") {
            topsGrid.appendChild(card);
        } else {
            bottomsGrid.appendChild(card);
        }
    });
}

searchInput.addEventListener("input", renderProducts);

// try-on
async function autoTryOn() {
    if (!currentFile) {
        statusDiv.style.color = "red";
        statusDiv.textContent = "Upload your photo first.";
        return;
    }
    if (!selectedTop && !selectedBottom) return;

    const form = new FormData();
    form.append("file", currentFile);
    if (selectedTop) form.append("top_url", selectedTop);
    if (selectedBottom) form.append("bottom_url", selectedBottom);
    form.append("gender", currentGender);

    statusDiv.style.color = "black";
    statusDiv.textContent = "Applying outfit...";

    const res = await fetch("/tryon", { method: "POST", body: form });
    const data = await res.json();

    if (data.image_base64) {
        document.getElementById("resultImage").src =
            "data:image/png;base64," + data.image_base64;
        document.getElementById("resultActions").style.display = "block";
        statusDiv.style.color = "green";
        statusDiv.textContent =
            "Outfit applied. Change top/bottom or add to wishlist.";
    } else {
        statusDiv.style.color = "red";
        statusDiv.textContent = "Error applying outfit.";
        alert("Error: " + JSON.stringify(data));
    }
}

// wishlist
function toggleWishlist(url) {
    if (wishlist.has(url)) {
        wishlist.delete(url);
    } else {
        wishlist.add(url);
    }
    renderWishlist();
}

function renderWishlist() {
    wishlistBar.innerHTML = "";
    wishlist.forEach(url => {
        const wrap = document.createElement("div");
        wrap.className = "wish-item";

        const img = document.createElement("img");
        img.src = url;

        img.onclick = async () => {
            const item = allProducts.find(p => p.url === url);
            if (!item) return;

            if (item.type === "top") {
                selectedTop = url;
                document.querySelectorAll(".product-card.top img")
                    .forEach(i => {
                        if (i.src === url) i.classList.add("selected");
                        else i.classList.remove("selected");
                    });
            } else {
                selectedBottom = url;
                document.querySelectorAll(".product-card.bottom img")
                    .forEach(i => {
                        if (i.src === url) i.classList.add("selected");
                        else i.classList.remove("selected");
                    });
            }
            await autoTryOn();
        };

        const removeBtn = document.createElement("span");
        removeBtn.textContent = "×";
        removeBtn.className = "remove-btn";
        removeBtn.onclick = () => {
            wishlist.delete(url);
            renderWishlist();
            document.querySelectorAll(".product-card").forEach(card => {
                const imgTag = card.querySelector("img");
                const heart = card.querySelector(".wish-btn");
                if (imgTag && heart && imgTag.src === url) {
                    heart.classList.remove("active");
                }
            });
        };

        wrap.appendChild(img);
        wrap.appendChild(removeBtn);
        wishlistBar.appendChild(wrap);
    });
}

// download current result
document.getElementById("downloadBtn").onclick = function () {
    const img = document.getElementById("resultImage");
    if (!img.src) {
        alert("No try-on image to download yet.");
        return;
    }

    const link = document.createElement("a");
    link.href = img.src;
    link.download = "tryon.png";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// save current try-on
document.getElementById("saveTryOnBtn").onclick = function () {
    const img = document.getElementById("resultImage");
    if (!img.src) {
        alert("No try-on image to save yet.");
        return;
    }
    if (savedTryOns.includes(img.src)) return;
    savedTryOns.push(img.src);
    renderTryOnGallery();
};

function renderTryOnGallery() {
    tryonGallery.innerHTML = "";
    savedTryOns.forEach(src => {
        const wrap = document.createElement("div");
        wrap.className = "tryon-item";

        const image = document.createElement("img");
        image.src = src;

        const removeBtn = document.createElement("span");
        removeBtn.textContent = "×";
        removeBtn.className = "remove-tryon";
        removeBtn.onclick = () => {
            savedTryOns = savedTryOns.filter(s => s !== src);
            renderTryOnGallery();
        };

        wrap.appendChild(image);
        wrap.appendChild(removeBtn);
        tryonGallery.appendChild(wrap);
    });
}
</script>
</body>
</html>
