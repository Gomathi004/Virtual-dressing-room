<!DOCTYPE html>
<html>
<head>
    <title>Virtual Dressing Room</title>
    <style>
        body { font-family: Arial; margin: 20px; }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1.2fr;
            grid-template-rows: auto auto auto auto;
            gap: 16px;
            align-items: start;
        }

        .box {
            border: 1px solid #d0d0d0;
            padding: 8px;
            text-align: center;
            background: #fafafa;
            border-radius: 6px;
        }

        .box h3 {
            margin: 0 0 4px 0;
            font-size: 18px;
        }

        .box img {
            max-width: 100%;
            max-height: 360px;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
            margin: 0 auto;
            background: #f5f5f5;
            border-radius: 4px;
        }

        /* layout regions */
        #upload-box {
            grid-column: 1;
            grid-row: 1 / span 2;
        }

        #result-box {
            grid-column: 2;
            grid-row: 1 / span 2;
        }

        #search-bar-box {
            grid-column: 3;
            grid-row: 1;
        }

        #clothes-box {
            grid-column: 3;
            grid-row: 2 / span 5;
        }

        .products-two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            text-align: left;
        }

        .products-subbox h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
        }

        #saved-sections {
            grid-column: 1 / span 2;
            grid-row: 4;
            padding: 8px;
            display: grid;
            grid-template-rows: auto auto;
            row-gap: 4px;
        }

        #wishlist-section,
        #tryon-gallery-section {
            margin: 0;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            padding: 6px;
            background: #fafafa;
        }

        #wishlist-section h3,
        #tryon-gallery-section h3 {
            margin: 0 0 4px 0;
        }

        #searchInput {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .products-list {
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            padding: 8px;
            background: #ffffff;
            max-height: 520px;
            overflow-y: auto;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .product-card {
            position: relative;
            background: #ffffff;
            border-radius: 6px;
            padding: 4px;
        }

        .product-card img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 4px;
            border: 2px solid transparent;
            background: #f8f8f8;
            cursor: pointer;
            display: block;
        }

        .product-card.top img.selected {
            border-color: #1976d2;
        }

        .product-card.bottom img.selected {
            border-color: #2e7d32;
        }

        .wish-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background: rgba(255,255,255,0.95);
            font-size: 16px;
            line-height: 26px;
            text-align: center;
            color: #888;
        }

        .wish-btn.active {
            color: #e53935;
        }

        .type-label {
            position: absolute;
            left: 6px;
            top: 6px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            font-size: 11px;
            padding: 2px 5px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        #statusMessage {
            grid-column: 1 / span 2;
            grid-row: 3;
            margin-top: 4px;
            font-weight: bold;
            text-align: center;
            padding: 4px 0;
        }

        #wishlist-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            border: 1px solid #d0d0d0;
            padding: 8px;
            background: #ffffff;
            min-height: 40px;
        }

        #wishlist-bar .wish-item {
            position: relative;
        }

        #wishlist-bar img {
            height: 80px;
            width: auto;
            object-fit: contain;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            background: #ffffff;
        }

        #wishlist-bar .remove-btn {
            position: absolute;
            top: 2px;
            right: 4px;
            cursor: pointer;
            background: white;
            border-radius: 50%;
            padding: 0 4px;
            font-size: 14px;
            line-height: 14px;
        }

        #tryon-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            border: 1px solid #d0d0d0;
            padding: 8px;
            background: #ffffff;
            min-height: 40px;
        }

        #tryon-gallery .tryon-item {
            position: relative;
        }

        #tryon-gallery img {
            height: 100px;
            width: auto;
            object-fit: contain;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: #fff;
        }

        #tryon-gallery .remove-tryon {
            position: absolute;
            top: 2px;
            right: 4px;
            cursor: pointer;
            background: white;
            border-radius: 50%;
            padding: 0 4px;
            font-size: 14px;
            line-height: 14px;
        }

        #downloadBtn, #saveTryOnBtn {
            padding: 6px 12px;
            margin: 0 4px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #444;
            background: #fff;
        }

        #resultActions {
            margin-top: 8px;
            display: none;
        }

        @media (max-width: 1000px) {
            .main-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
            #upload-box,
            #result-box,
            #search-bar-box,
            #clothes-box,
            #saved-sections,
            #statusMessage {
                grid-column: 1;
                grid-row: auto;
            }
        }
    </style>
</head>
<body>
<h2>Virtual Dressing Room</h2>

<div class="main-layout">

  <!-- 1. Upload your image -->
  <div class="box" id="upload-box">
    <h3>Upload Your Image</h3>
    <input type="file" id="inputImage" accept="image/*"><br><br>
    <img id="userPreview">
  </div>

  <!-- 2. Result -->
  <div class="box" id="result-box">
    <h3>Result</h3>
    <img id="resultImage">
    <div id="resultActions">
      <button id="downloadBtn">Download Image</button>
      <button id="saveTryOnBtn">Save to Liked</button>
    </div>
  </div>

  <!-- 3. Search bar -->
  <div class="box" id="search-bar-box">
    <h3>Search Outfits</h3>
    <input
      type="text"
      id="searchInput"
      placeholder="Search (e.g. red top, blue bottom, jeans, pant)...">
  </div>

  <!-- 4+5. Clothes: Tops + Bottoms -->
  <div class="box" id="clothes-box">
    <h3>Clothes</h3>
    <div class="products-two-col">
      <div class="products-subbox">
        <h4>Tops</h4>
        <div class="products-list">
          <div id="tops-grid" class="products-grid"></div>
        </div>
      </div>
      <div class="products-subbox">
        <h4>Bottoms</h4>
        <div class="products-list">
          <div id="bottoms-grid" class="products-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- status under upload+result -->
  <div id="statusMessage"></div>

  <!-- 6+7. Combined row: wishlist + try-on -->
  <div id="saved-sections" class="box">
    <div id="wishlist-section">
      <h3>Saved Wishlist</h3>
      <div id="wishlist-bar"></div>
    </div>

    <div id="tryon-gallery-section">
      <h3>Saved Try-On Images</h3>
      <div id="tryon-gallery"></div>
    </div>
  </div>

</div>

<script>
let currentGender = "men";
let currentFile = null;
let selectedTop = null;
let selectedBottom = null;

// track what last try-on request wanted
let lastRequestedTop = null;
let lastRequestedBottom = null;

let allProducts = [];   // { url, type, title, color }
let wishlist = new Set();
let savedTryOns = [];   // base64 strings

const statusDiv = document.getElementById("statusMessage");
const topsGrid = document.getElementById("tops-grid");
const bottomsGrid = document.getElementById("bottoms-grid");
const wishlistBar = document.getElementById("wishlist-bar");
const searchInput = document.getElementById("searchInput");
const tryonGallery = document.getElementById("tryon-gallery");

// color guess from file name
function guessColorFromName(name) {
    name = name.toLowerCase();
    if (name.includes("red")) return "red";
    if (name.includes("black")) return "black";
    if (name.includes("white")) return "white";
    if (name.includes("blue")) return "blue";
    if (name.includes("green")) return "green";
    return "";
}

// status helper
function setStatus(message, color = "black") {
    statusDiv.textContent = message;
    statusDiv.style.color = color;
}

// upload handler
document.getElementById("inputImage").onchange = async function (e) {
    const file = e.target.files[0];
    if (!file) return;

    currentFile = file;
    document.getElementById("userPreview").src =
        URL.createObjectURL(file);

    selectedTop = null;
    selectedBottom = null;
    lastRequestedTop = null;
    lastRequestedBottom = null;

    topsGrid.innerHTML = "";
    bottomsGrid.innerHTML = "";
    document.getElementById("resultImage").src = "";
    document.getElementById("resultActions").style.display = "none";

    setStatus("Analyzing your photo… finding your perfect fit.", "black");
    await classifyGenderAndLoadProducts(file);
};

async function classifyGenderAndLoadProducts(file) {
    const form = new FormData();
    form.append("file", file);

    try {
        const res = await fetch("/classify-gender", { method: "POST", body: form });
        const data = await res.json();

        if (!res.ok) {
            if (data.error === "no_person") {
                setStatus("No full body found. Try a clear, full‑body photo.", "red");
            } else if (data.error === "gender_unknown") {
                setStatus("Could not understand the photo. Try a front‑facing pose.", "red");
            } else {
                setStatus("Could not read the photo right now. Please try again.", "red");
            }
            topsGrid.innerHTML = "";
            bottomsGrid.innerHTML = "";
            document.getElementById("resultImage").src = "";
            return;
        }

        currentGender = data.gender;
        setStatus("Style mode on. Pick a top and a bottom to begin.", "green");

        await loadProducts(currentGender);
        renderProducts();
        setStatus("Outfits ready. Tap a top and a bottom to try them on.", "green");
    } catch (err) {
        setStatus("Server is taking a short break. Please try again.", "red");
    }
}

// load products from backend
async function loadProducts(gender) {
    const res = await fetch(`/clothes?gender=${encodeURIComponent(gender)}`);
    const data = await res.json();   // [{url, type}, ...]

    allProducts = data.map(item => {
        const url = item.url;
        const kind = (item.type || "").toLowerCase(); // "top" or "bottom"
        let name = url.split("/").pop().split(".")[0];
        name = name.replace(/[_\-]+/g, " ");

        const color = guessColorFromName(name);
        const title = (kind + " " + name + " " + color).toLowerCase();
        return { url, type: kind, title, color };
    });
}

// show products
function renderProducts() {
    topsGrid.innerHTML = "";
    bottomsGrid.innerHTML = "";

    const q = searchInput.value.trim().toLowerCase();

    allProducts.forEach(item => {
        const text = (item.title + " " + item.url).toLowerCase();
        if (q && !text.includes(q)) return;

        const card = document.createElement("div");
        card.className = "product-card " + item.type;

        const typeLabel = document.createElement("div");
        typeLabel.className = "type-label";
        typeLabel.textContent = item.type;

        const img = document.createElement("img");
        img.src = item.url;
        img.alt = item.title;
        img.title = item.title;

        img.onclick = async () => {
            document.querySelectorAll(".product-card." + item.type + " img")
                .forEach(i => i.classList.remove("selected"));
            img.classList.add("selected");

            if (item.type === "top") {
                selectedTop = item.url;
            } else {
                selectedBottom = item.url;
            }

            // remember what this request is trying to apply
            lastRequestedTop = selectedTop;
            lastRequestedBottom = selectedBottom;

            if (selectedTop && selectedBottom) {
                setStatus("Applying your full outfit… just a moment.", "black");
            } else if (selectedTop) {
                setStatus("Applying the new top…", "black");
            } else {
                setStatus("Applying the new bottom…", "black");
            }

            await autoTryOn();
        };

        const heart = document.createElement("button");
        heart.className = "wish-btn";
        heart.innerHTML = "❤";

        if (wishlist.has(item.url)) {
            heart.classList.add("active");
        }

        heart.onclick = (event) => {
            event.stopPropagation();
            toggleWishlist(item.url);
            if (wishlist.has(item.url)) {
                heart.classList.add("active");
                setStatus("Saved to wishlist. Come back to this style anytime.", "green");
            } else {
                heart.classList.remove("active");
                setStatus("Removed from wishlist.", "black");
            }
        };

        card.appendChild(img);
        card.appendChild(typeLabel);
        card.appendChild(heart);

        if (item.type === "top") {
            topsGrid.appendChild(card);
        } else {
            bottomsGrid.appendChild(card);
        }
    });
}

searchInput.addEventListener("input", renderProducts);

// try-on
async function autoTryOn() {
    if (!currentFile) {
        setStatus("Upload your photo to start trying outfits.", "red");
        return;
    }
    if (!selectedTop && !selectedBottom) {
        setStatus("Select at least a top or a bottom to try on.", "red");
        return;
    }

    const form = new FormData();
    form.append("file", currentFile);
    if (selectedTop) form.append("top_url", selectedTop);
    if (selectedBottom) form.append("bottom_url", selectedBottom);
    form.append("gender", currentGender);

    // loading message already set before the call; keep it

    try {
        const res = await fetch("/tryon", { method: "POST", body: form });
        const data = await res.json();

        if (data.image_base64) {
            document.getElementById("resultImage").src =
                "data:image/png;base64," + data.image_base64;
            document.getElementById("resultActions").style.display = "block";

            // success messages – no more “still catching up”
            if (lastRequestedTop && lastRequestedBottom) {
                setStatus("Full outfit ready. Love it? Save or switch pieces.", "green");
            } else if (lastRequestedTop && !lastRequestedBottom) {
                setStatus("New top applied. Bottom stays as it is.", "green");
            } else if (!lastRequestedTop && lastRequestedBottom) {
                setStatus("New bottom applied. Top stays as it is.", "green");
            } else {
                setStatus("Look updated.", "green");
            }

            // reset flags for next request
            lastRequestedTop = null;
            lastRequestedBottom = null;

        } else {
            setStatus("Could not style this outfit right now. Please try again.", "red");
            alert("Error: " + JSON.stringify(data));
        }
    } catch (err) {
        setStatus("Server is busy styling others. Try again in a few seconds.", "red");
    }
}

// wishlist
function toggleWishlist(url) {
    if (wishlist.has(url)) {
        wishlist.delete(url);
    } else {
        wishlist.add(url);
    }
    renderWishlist();
}

function renderWishlist() {
    wishlistBar.innerHTML = "";
    wishlist.forEach(url => {
        const wrap = document.createElement("div");
        wrap.className = "wish-item";

        const img = document.createElement("img");
        img.src = url;

        img.onclick = async () => {
            const item = allProducts.find(p => p.url === url);
            if (!item) return;

            if (item.type === "top") {
                selectedTop = url;
                document.querySelectorAll(".product-card.top img")
                    .forEach(i => {
                        if (i.src === url) i.classList.add("selected");
                        else i.classList.remove("selected");
                    });
            } else {
                selectedBottom = url;
                document.querySelectorAll(".product-card.bottom img")
                    .forEach(i => {
                        if (i.src === url) i.classList.add("selected");
                        else i.classList.remove("selected");
                    });
            }

            lastRequestedTop = selectedTop;
            lastRequestedBottom = selectedBottom;
            setStatus("Re‑applying your saved look…", "black");
            await autoTryOn();
        };

        const removeBtn = document.createElement("span");
        removeBtn.textContent = "×";
        removeBtn.className = "remove-btn";
        removeBtn.onclick = () => {
            wishlist.delete(url);
            renderWishlist();
            document.querySelectorAll(".product-card").forEach(card => {
                const imgTag = card.querySelector("img");
                const heart = card.querySelector(".wish-btn");
                if (imgTag && heart && imgTag.src === url) {
                    heart.classList.remove("active");
                }
            });
            setStatus("Removed from wishlist.", "black");
        };

        wrap.appendChild(img);
        wrap.appendChild(removeBtn);
        wishlistBar.appendChild(wrap);
    });
}

// download current result
document.getElementById("downloadBtn").onclick = function () {
    const img = document.getElementById("resultImage");
    if (!img.src) {
        alert("No try-on image to download yet.");
        return;
    }

    const link = document.createElement("a");
    link.href = img.src;
    link.download = "tryon.png";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    setStatus("Look saved to your device. Share your style!", "green");
};

// save current try-on
document.getElementById("saveTryOnBtn").onclick = function () {
    const img = document.getElementById("resultImage");
    if (!img.src) {
        alert("No try-on image to save yet.");
        return;
    }
    if (savedTryOns.includes(img.src)) {
        setStatus("This look is already in your saved try-ons.", "black");
        return;
    }
    savedTryOns.push(img.src);
    renderTryOnGallery();
    setStatus("Look added to Saved Try‑On Images.", "green");
};

function renderTryOnGallery() {
    tryonGallery.innerHTML = "";
    savedTryOns.forEach(src => {
        const wrap = document.createElement("div");
        wrap.className = "tryon-item";

        const image = document.createElement("img");
        image.src = src;

        const removeBtn = document.createElement("span");
        removeBtn.textContent = "×";
        removeBtn.className = "remove-tryon";
        removeBtn.onclick = () => {
            savedTryOns = savedTryOns.filter(s => s !== src);
            renderTryOnGallery();
            setStatus("Removed from Saved Try‑On Images.", "black");
        };

        wrap.appendChild(image);
        wrap.appendChild(removeBtn);
        tryonGallery.appendChild(wrap);
    });
}
</script>
</body>
</html>
